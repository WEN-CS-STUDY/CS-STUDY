[스레드 03. 동기화(Synchronization)](https://jinn-blog.tistory.com/207)

### 동기화

- 멀티스레딩 환경에서 여러 스레드가 공유 자원에 안전하게 접근할 수 있도록 해주는 기법
    - 동시에 접근하면 데이터 불일치나 충돌이 일어날 수 있음.
    - 이러한 경우를 레이스 컨디션이라고 한다.
    - 동기화는 여러 스레드가 공유 자원에 접근할 때 특정 스레드만 접근할 수 있도록 제어하여 데이터의 일관성과 정확성을 보장해준다.

```java
public class Counter {
    private int count = 0;

    public void increment() {
        count++;
    }

    public int getCount() {
        return count;
    }
}
```

- 특정 스레드가 count++;를 실행하면서 더한 값을 아직 저장하지 않았는데 또 다른 스레드가 이걸 읽으면 예상 값보다 작아질 수 있다.

### 임계 영역

- 멀티 스레드 환경에서 각 스레드들이 공유하는 데이터를 변경하는 영역
- 다음 세 가지 조건을 만족하면 안전하게 레이스 컨디션 예방 가능하다.
    - 상호 배제 : 한번에 하나의 스레드만
    - 진행 : 임계 영역 진입은 공정하게 이루어져야 한다. (무한정 결정 X)
    - 제한된 대기  : 어떤 스레드가 무한히 대기하는 일은 없어야 한다.

### 동기화 기법

1. 뮤텍스
    1. 잠금과 해제를 이용하여 한번에 하나의 스레드만 공유 자원에 접근할 수 있도록 함 (상호 배제)
    
    ```java
    public class Counter {
        private int count = 0;
    
        // synchronized 키워드를 사용하여 동기화 처리
        public synchronized void increment() {
            count++;
        }
    
        public synchronized int getCount() {
            return count;
        }
    }
    ```
    
2. 락
    1. 특정 자원을 보호하기 위한 동기화 방법 
    2. 자원을 사용하려는 스레드는 락을 얻어야 하고 다 사용하면 락을 반환해야 함. 
    
    ```java
    import java.util.concurrent.locks.ReentrantLock;
    
    public class Counter {
        private int count = 0;
        private ReentrantLock lock = new ReentrantLock();
    
        public void increment() {
            lock.lock(); // 락을 얻음
            try {
                count++;
            } finally {
                lock.unlock(); // 락을 해제
            }
        }
    
        public int getCount() {
            return count;
        }
    }
    ```
    
    - ReetrantLock 클래스로 락을 관리
3. 세마포어
    1. 뮤텍스와 비슷하지만 동시에 접근할 수 있는 스레드 수를 지정할 수 있다.
    2. 자원을 병렬로 처리해야 하는데 스레드 수를 지정하고 싶을 때 사용
    
    ```java
    import java.util.concurrent.Semaphore;
    
    public class Resource {
        private Semaphore semaphore = new Semaphore(3); // 동시에 3개의 스레드만 접근 가능
    
        public void accessResource() throws InterruptedException {
            semaphore.acquire(); // 세마포어 획득
            try {
                // 자원에 접근하는 코드
            } finally {
                semaphore.release(); // 세마포어 해제
            }
        }
    }
    ```
    
    - SemaPhore 클래스로 관리
4. 모니터
    1. 객체 수준에서 스레드간 동기화를 관리하는 메커니즘
    

### 동기화 문제

1. 데드락
    1. 서로가 가진 자원을 기다리며 영원히 멈춰있는 상태
2. 레이스 컨디션
    1. 여러 스레드가 동시에 공유 자원에 접근할 때 발생하는 예측 불가능한 동작 
    2. 어느 스레드가 먼저 실행될지 예측할 수 없어서 그렇다.